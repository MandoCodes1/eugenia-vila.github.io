---
import { Icon } from 'astro-icon/components';
import type { Review } from '~/utils/reviews';

export interface Props {
  reviews: Review[];
  language?: 'es' | 'en';
}

const { reviews, language = 'es' } = Astro.props;

function getInitials(name: string): string {
  return name
    .split(' ')
    .map((word) => word[0])
    .join('')
    .toUpperCase()
    .slice(0, 2);
}

function getAvatarColor(avatar: string): string {
  if (avatar.includes('green')) return 'bg-green-500';
  if (avatar.includes('pink')) return 'bg-pink-500';
  if (avatar.includes('yellow')) return 'bg-yellow-500';
  if (avatar.includes('orange')) return 'bg-orange-500';
  if (avatar.includes('blue')) return 'bg-blue-500';
  return 'bg-blue-500';
}

function getSourceIcon(source: string): string {
  if (source.toLowerCase() === 'google') return 'tabler:brand-google';
  if (source.toLowerCase() === 'trustpilot') return 'tabler:star';
  return 'tabler:star';
}

// Generate unique ID for each review
function getReviewId(index: number, name: string): string {
  return `review-${index}-${name.toLowerCase().replace(/\s+/g, '-')}`;
}
---

<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
  {
    reviews.map((review, index) => {
      const text = language === 'es' ? review.text_es : review.text_en;
      const isImageAvatar = review.avatar.startsWith('http');
      const avatarColor = getAvatarColor(review.avatar);
      const initials = getInitials(review.name);
      const reviewId = getReviewId(index, review.name);

      return (
        <div class="flex flex-col p-6 bg-white dark:bg-slate-900 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300">
          {/* Header with Avatar and Name */}
          <div class="flex items-start gap-4 mb-4">
            <div class="flex-shrink-0">
              {isImageAvatar ? (
                <img
                  src={review.avatar}
                  alt={review.name}
                  class="w-12 h-12 rounded-full object-cover"
                  loading="lazy"
                />
              ) : (
                <div class={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold ${avatarColor}`}>
                  {initials}
                </div>
              )}
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="font-semibold text-lg text-gray-900 dark:text-white truncate">{review.name}</h3>
              <div class="flex items-center gap-2 mt-1">
                <div class="flex">
                  {[...Array(5)].map((_, i) => (
                    <Icon
                      name="tabler:star-filled"
                      class={`w-4 h-4 ${i < review.rating ? 'text-yellow-400' : 'text-gray-300'}`}
                    />
                  ))}
                </div>
                <span class="text-sm text-muted">{review.date}</span>
              </div>
            </div>
          </div>

          {/* Review Text */}
          <div class="flex-1 mb-4">
            <p 
              id={`${reviewId}-text`}
              class="review-text text-gray-700 dark:text-gray-300 line-clamp-6"
              data-full-text={text}
            >
              {text}
            </p>
            <button
              id={`${reviewId}-toggle`}
              class="review-toggle hidden mt-2 text-sm text-primary hover:text-secondary transition-colors font-medium cursor-pointer focus:outline-none rounded"
              data-review-id={reviewId}
              aria-label={language === 'es' ? 'Expandir o contraer reseña' : 'Expand or collapse review'}
            >
              {language === 'es' ? 'Leer más' : 'Read more'}
            </button>
          </div>

          {/* Footer with Source and Link */}
          <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex items-center gap-2 text-sm text-muted">
              <Icon name={getSourceIcon(review.source)} class="w-4 h-4" />
              <span>{review.source}</span>
            </div>
            <a
              href={review.link}
              target="_blank"
              rel="noopener noreferrer"
              class="text-sm text-primary hover:text-secondary transition-colors"
            >
              {language === 'es' ? 'Ver reseña' : 'View review'} →
            </a>
          </div>
        </div>
      );
    })
  }
</div>

<style>
  .line-clamp-6 {
    display: -webkit-box;
    -webkit-line-clamp: 6;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .review-text.expanded {
    display: block;
    -webkit-line-clamp: unset;
    overflow: visible;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const reviewTexts = document.querySelectorAll('.review-text');

    reviewTexts.forEach((textElement) => {
      const reviewId = textElement.id.replace('-text', '');
      const toggleButton = document.getElementById(`${reviewId}-toggle`);
      
      if (!toggleButton) return;

      // Determine language from button's initial text
      const initialButtonText = toggleButton.textContent?.trim() || '';
      const isSpanish = initialButtonText === 'Leer más';
      const readMoreText = isSpanish 
        ? { more: 'Leer más', less: 'Leer menos' }
        : { more: 'Read more', less: 'Read less' };

      // Check if text is actually truncated
      const isTruncated = textElement.scrollHeight > textElement.clientHeight;
      
      if (isTruncated) {
        toggleButton.classList.remove('hidden');
        
        toggleButton.addEventListener('click', () => {
          const isExpanded = textElement.classList.contains('expanded');
          
          if (isExpanded) {
            textElement.classList.remove('expanded');
            toggleButton.textContent = readMoreText.more;
          } else {
            textElement.classList.add('expanded');
            toggleButton.textContent = readMoreText.less;
          }
        });
      }
    });
  });
</script>

