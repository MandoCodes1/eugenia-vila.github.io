---
import Headline from '~/components/ui/Headline.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Button from '~/components/ui/Button.astro';
import Image from '~/components/common/Image.astro';
import { Icon } from 'astro-icon/components';
import type { Testimonials as Props } from '~/types';

const {
  title = '',
  subtitle = '',
  tagline = '',
  testimonials = [],
  callToAction,
  language = 'en',

  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;

function getInitials(name: string): string {
  return name
    .split(' ')
    .map((word) => word[0])
    .join('')
    .toUpperCase()
    .slice(0, 2);
}

function getAvatarColor(image: string | unknown): string {
  if (typeof image === 'string') {
    if (image.includes('green')) return 'bg-green-500';
    if (image.includes('pink')) return 'bg-pink-500';
    if (image.includes('yellow')) return 'bg-yellow-500';
    if (image.includes('orange')) return 'bg-orange-500';
    if (image.includes('blue')) return 'bg-blue-500';
  }
  return 'bg-blue-500';
}

function getSourceIcon(source: string): string {
  if (source.toLowerCase() === 'google') return 'tabler:brand-google';
  if (source.toLowerCase() === 'trustpilot') return 'tabler:star';
  return 'tabler:star';
}

// Generate unique ID for each testimonial
function getTestimonialId(index: number, name: string): string {
  return `testimonial-${index}-${name?.toLowerCase().replace(/\s+/g, '-') || index}`;
}
---

<WidgetWrapper id={id} isDark={isDark} containerClass={`max-w-7xl mx-auto ${classes?.container ?? ''}`} bg={bg}>
  <Headline title={title} subtitle={subtitle} tagline={tagline} />

  <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
    {
      testimonials &&
        testimonials.map(({ testimonial, name, image, rating, date, source, link }, index) => {
          const isImageAvatar = typeof image === 'object' && image !== null && 'src' in image && typeof image.src === 'string' && image.src.startsWith('http');
          const imageSrc = typeof image === 'object' && image !== null && 'src' in image && typeof image.src === 'string' ? image.src : (typeof image === 'string' ? image : '');
          const avatarColor = getAvatarColor(imageSrc);
          const initials = name ? getInitials(name) : '';
          const testimonialId = getTestimonialId(index, name || '');

          return (
            <div class="flex flex-col p-6 bg-white dark:bg-slate-900 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300">
              {/* Header with Avatar and Name */}
              <div class="flex items-start gap-4 mb-4">
                <div class="flex-shrink-0">
                  {isImageAvatar ? (
                    <img
                      src={imageSrc}
                      alt={name || ''}
                      class="w-12 h-12 rounded-full object-cover"
                      loading="lazy"
                    />
                  ) : image ? (
                    typeof image === 'string' ? (
                      <Fragment set:html={image} />
                    ) : (
                      <Image
                        class="w-12 h-12 rounded-full object-cover"
                        width={48}
                        height={48}
                        widths={[400, 768]}
                        layout="fixed"
                        {...(typeof image === 'object' ? image : {})}
                      />
                    )
                  ) : name ? (
                    <div class={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold ${avatarColor}`}>
                      {initials}
                    </div>
                  ) : null}
                </div>
                <div class="flex-1 min-w-0">
                  {name && <h3 class="font-semibold text-lg text-gray-900 dark:text-white truncate">{name}</h3>}
                  <div class="flex items-center gap-2 mt-1">
                    {rating !== undefined && (
                      <div class="flex">
                        {[...Array(5)].map((_, i) => (
                          <Icon
                            name="tabler:star-filled"
                            class={`w-4 h-4 ${i < rating ? 'text-yellow-400' : 'text-gray-300'}`}
                          />
                        ))}
                      </div>
                    )}
                    {date && <span class="text-sm text-muted">{date}</span>}
                  </div>
                </div>
              </div>

              {/* Testimonial Text */}
              {testimonial && (
                <div class="flex-1 mb-4">
                  <p 
                    id={`${testimonialId}-text`}
                    class="testimonial-text text-gray-700 dark:text-gray-300 line-clamp-6"
                    data-full-text={testimonial}
                  >
                    {testimonial}
                  </p>
                  <button
                    id={`${testimonialId}-toggle`}
                    class="testimonial-toggle hidden mt-2 text-sm text-primary hover:text-secondary transition-colors font-medium cursor-pointer focus:outline-none rounded"
                    data-testimonial-id={testimonialId}
                    aria-label={language === 'es' ? 'Expandir o contraer testimonio' : 'Expand or collapse testimonial'}
                  >
                    {language === 'es' ? 'Leer más' : 'Read more'}
                  </button>
                </div>
              )}

              {/* Footer with Source and Link */}
              {(source || link) && (
                <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                  {source && (
                    <div class="flex items-center gap-2 text-sm text-muted">
                      <Icon name={getSourceIcon(source)} class="w-4 h-4" />
                      <span>{source}</span>
                    </div>
                  )}
                  {link && (
                    <a
                      href={link}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-sm text-primary hover:text-secondary transition-colors"
                    >
                      {language === 'es' ? 'Ver reseña' : 'View review'} →
                    </a>
                  )}
                </div>
              )}
            </div>
          );
        })
    }
  </div>
  {
    callToAction && (
      <div class="flex justify-center mx-auto w-fit mt-8 md:mt-12 font-medium">
        <Button {...callToAction} />
      </div>
    )
  }
</WidgetWrapper>

<style>
  .line-clamp-6 {
    display: -webkit-box;
    -webkit-line-clamp: 6;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .testimonial-text.expanded {
    display: block;
    -webkit-line-clamp: unset;
    overflow: visible;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const testimonialTexts = document.querySelectorAll('.testimonial-text');

    testimonialTexts.forEach((textElement) => {
      const testimonialId = textElement.id.replace('-text', '');
      const toggleButton = document.getElementById(`${testimonialId}-toggle`);
      
      if (!toggleButton) return;

      // Determine language from button's initial text
      const initialButtonText = toggleButton.textContent?.trim() || '';
      const isSpanish = initialButtonText === 'Leer más';
      const readMoreText = isSpanish 
        ? { more: 'Leer más', less: 'Leer menos' }
        : { more: 'Read more', less: 'Read less' };

      // Check if text is actually truncated
      const isTruncated = textElement.scrollHeight > textElement.clientHeight;
      
      if (isTruncated) {
        toggleButton.classList.remove('hidden');
        
        toggleButton.addEventListener('click', () => {
          const isExpanded = textElement.classList.contains('expanded');
          
          if (isExpanded) {
            textElement.classList.remove('expanded');
            toggleButton.textContent = readMoreText.more;
          } else {
            textElement.classList.add('expanded');
            toggleButton.textContent = readMoreText.less;
          }
        });
      }
    });
  });
</script>
